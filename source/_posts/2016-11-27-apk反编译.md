---
title: 反编译 Apk
tags:
  - android
  - 调试
date: 2016-11-27 15:37:22
categories: 笔记
---

> apk文件等同于一个包含了资源和已编译java的压缩文件，如果简单地解压一个apk文件，将会得到许多如classes.dex和resources.arcs的文件。

## 工具

apktool资源文件获取（如果只是为了获取图片，可以直接解压apk，可能有惊喜）

dex2jar源码文件获取

jd-gui源码查看

### apktool

[官网](https://ibotpeaches.github.io/Apktool/)

#### 功能

+ 将资源反编译到接近源文件形式
+ 将解码后的资源rebuild到apk/jar的二进制形式
+ ....

#### 安装步骤（Windows）

1. [下载](https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/windows/apktool.bat)window脚本文件（右键另存为，如apktools.bat），此脚本不是必须的，只是避免每一次都需要输入java -jar apktool.jar
2. [下载](https://bitbucket.org/iBotPeaches/apktool/downloads)apktool-2
3. 将下载的jar文件重命名为apktool.jar
4. 将apktool.jar和apktool.bat放到Windows目录下（通常为c://Windows）
5. 如果没有c://Windows权限，则需要将两个文件置于任意目录并将该目录添加到系统环境变量的Path变量中
6. 根据提示执行apktool命令

#### Decoding解码

```shell
$ apktool d foo.jar
// decodes foo.jar to foo.jar.out folder

$ apktool decode foo.jar
// decodes foo.jar to foo.jar.out folder

$ apktool d bar.apk
// decodes bar.apk to bar folder

$ apktool decode bar.apk
// decodes bar.apk to bar folder

$ apktool d bar.apk -o baz
// decodes bar.apk to baz folder
```

#### Building

```shell
$ apktool b foo.jar.out
// builds foo.jar.out folder into foo.jar.out/dist/foo.jar file

$ apktool build foo.jar.out
// builds foo.jar.out folder into foo.jar.out/dist/foo.jar file

$ apktool b bar
// builds bar folder into bar/dist/bar.apk file

$ apktool b .
// builds current directory into ./dist

$ apktool b bar -o new_bar.apk
// builds bar folder into new_bar.apk

$ apktool b bar.apk
// WRONG: brut.androlib.AndrolibException: brut.directory.PathNotExist: apktool.yml
// Must use folder, not apk/jar file
```

为了rebuild应用，需要对应用进行重新签名。[android官方签名说明](https://developer.android.com/studio/publish/app-signing.html#signing-manually)

#### Frameworks

if或者install-framework,可以使用两个参数

- `-p, --frame-path ` - Store framework files into 
- `-t, --tag ` - Tag frameworks using 

安装frameworks是为了反编译一些与系统资源关联的apk，没有实际试验过，所以也算不上很明白，暂时了解以下这个功能。

```
$ apktool if framework-res.apk
I: Framework installed to: 1.apk 
// pkgId of framework-res.apk determines number (which is 0x01)

$ apktool if com.htc.resources.apk
I: Framework installed to: 2.apk 
// pkgId of com.htc.resources is 0x02

$ apktool if com.htc.resources.apk -t htc
I: Framework installed to: 2-htc.apk 
// pkgId-tag.apk

$ apktool if framework-res.apk -p foo/bar
I: Framework installed to: foo/bar/1.apk

$ apktool if framework-res.apk -t baz -p foo/bar
I: Framework installed to: foo/bar/1-baz.apk
```

### dex2jar

[官网](https://github.com/pxb1988/dex2jar)

将.dex(android dalvik)转换为.class(java)形式的工具。

#### 工具集合

+ dex-reader/writer:读写Dalvik可执行文件(.dex)。
+ d2j-dex2jar:将.dex文件转换为.class文件。
+ smail/baksmall:将dex分解为smail，将smail合成dex。
+ ...

#### 使用

1. 安装JDK7

2. [下载](https://sourceforge.net/projects/dex2jar/files/)

3. 解压

4. 生成.jar文件

   ```shell
   // For Linux, Mac OSX, Cygwin
   sh /home/panxiaobo/dex2jar-version/d2j-dex2jar.sh /home/panxiaobo/someApk.apk
   // For Windows
   C:\dex2jar-version\d2j-dex2jar.bat someApk.apk
   //也可以直接将apk文件拖到bat文件中执行
   ```

5. 使用反编译器查看源码

   - [jd-gui](http://jd.benow.ca/)
   - [JAD](http://www.varaneckas.com/jad)
   - [Procyon](https://bitbucket.org/mstrobel/procyon)

### jd-gui

[官网](https://github.com/java-decompiler/jd-gui)

jd-gui是一个显示.class形式java源码的图形化工具。

[下载](http://jd.benow.ca/)

