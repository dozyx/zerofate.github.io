---
title: 原生设置里的恢复出厂设置
tags:
  - android
date: 2017-04-08 15:37:22
categories: 笔记
---

恢复出厂设置的代码在 `MasterClear`和`MasterClearConfirm` 两个类中。MasterClearConfirm是最后确认的地方，所以主要看这个类即可。



点击“清除所有内容”

```java
	public void onClick(View v) {
            if (Utils.isMonkeyRunning()) {//如果运行的是 Monkey 则不执行
                return;
            }
            final PersistentDataBlockManager pdbManager = (PersistentDataBlockManager)
                    getActivity().getSystemService(Context.PERSISTENT_DATA_BLOCK_SERVICE);
			// PersistentDataBlockManager是一个标记为 @hide 的类
            if (pdbManager != null && !pdbManager.getOemUnlockEnabled()) {
                // if OEM unlock is enabled, this will be wiped during FR process.
                final ProgressDialog progressDialog = getProgressDialog();
                progressDialog.show();

                // need to prevent orientation changes as we're about to go into
                // a long IO request, so we won't be able to access inflate resources on flash
                final int oldOrientation = getActivity().getRequestedOrientation();
                getActivity().setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_LOCKED);
                new AsyncTask<Void, Void, Void>() {
                    @Override
                    protected Void doInBackground(Void... params) {
                        pdbManager.wipe();
                      	//具体调用的是PersistentDataBlockService中的wipe
                      	//wipe路径通过SystemProperties.get(PERSISTENT_DATA_BLOCK_PROP)得到
                      	//PERSISTENT_DATA_BLOCK_PROP为"ro.frp.pst"
                      	//此处wipe的作用不清楚，似乎真正的清理不是在这里进行，难道是对某些分区进行还原？
                      	//文档说明：Zeroes the previously written block in its entirety. 
                      	//Calling this method will erase all 
                      	//data written to the persistent data partition.
                        return null;
                    }

                    @Override
                    protected void onPostExecute(Void aVoid) {
                        progressDialog.hide();
                        getActivity().setRequestedOrientation(oldOrientation);
                        doMasterClear();
                    }
                }.execute();
            } else {
                doMasterClear();
            }
        }
```

**doMasterClear**

```java
    private void doMasterClear() {
        if (mEraseSdCard) {//格式化SD卡
            Intent intent = new Intent(ExternalStorageFormatter.FORMAT_AND_FACTORY_RESET);
            intent.putExtra(Intent.EXTRA_REASON, "MasterClearConfirm");
            intent.setComponent(ExternalStorageFormatter.COMPONENT_NAME);
            getActivity().startService(intent);
          	//将启动 ExternalStorageFormatter 服务
          	//该服务可以格式化指定的卷或者（如果未指定）格式化第一个物理卷
          	//格式化成功后，同样会发送ACTION_MASTER_CLEAR广播
        } else {
            Intent intent = new Intent(Intent.ACTION_MASTER_CLEAR);
            intent.addFlags(Intent.FLAG_RECEIVER_FOREGROUND);
            intent.putExtra(Intent.EXTRA_REASON, "MasterClearConfirm");
            getActivity().sendBroadcast(intent);
            // Intent handling is asynchronous -- assume it will happen soon.
            //该广播在 MasterClearReceiver 中处理
          	// 会重启设备并抹除用户的数据和缓存分区
        }
    }
```

**isMonkeyRunning** 

```java
	/**
     * Returns true if Monkey is running.
     */
    public static boolean isMonkeyRunning() {
        return ActivityManager.isUserAMonkey();
    }
```

