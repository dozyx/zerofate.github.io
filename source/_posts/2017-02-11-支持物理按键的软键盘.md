---
title: 支持物理按键软键盘的实现
tags:
  - android
date: 2017-02-11 15:37:22
categories: 笔记
---

原理：在键盘视图的onDraw中绘制聚焦框，在输入法Service中拦截onKeyDown事件进行响应。

重要类

**InputMethodService**

KeyboardActionListener接口

软键盘事件的监听器（注：在源码的LatinIME中没有使用直接使用库中的接口，命名参数会不一样）

void onPress(intprimaryCode);//在onKey之前调用

void onRelease(intprimaryCode);//在onKey之后调用

void **onKey**(int primaryCode, int[] keyCodes);//keyCodes表示可切换键的所有可能编码，其第一个即primaryCode

voidonText(CharSequence text);//将显示的字符发送给listener

void swipeLeft();//用户快速从右向左划动

void swipeRight();

void swipeDown();

void swipeUp();

 

res目录(以SoftKeyboard sample为例)

**AndroidManifest.xml**

声明InputMethodService派生类并绑定在输入法之上

```xml
<service android:name="SoftKeyboard"
	android:permission="android.permission.BIND_INPUT_METHOD">
	<intent-filter>
		<action android:name="android.view.InputMethod" />
	</intent-filter>
	<meta-data android:name="android.view.im" android:resource="@xml/method" />
</service>
```

**strings.xml**

― ime_name 定义了该输入法的名字

― word_separators 词的分隔符，即输入过程中可能用来表示一个词输入完成的符号

― label_xx_key 为软键盘定义确认键的标签。在后面代码解析中可以看到，程序会根据输入框的信息来设置EnterKey的图标或者标签。如：在一个网址上面输入，就会显示一个搜索的图标，而在编辑短信时，如果在收信人写，那么EnterKey就是Next标签，用来直接跳到短信正文部分。

 

**dimens.xml**

定义软键盘的尺寸信息，包括键高(key_height)，候选词字体的高度(candidate_font_height)，候选词垂直间隙(candidate_vertical_padding)。

 

**color.xml**

定义候选词的背景颜色，比如正常(candidate_normal)，推荐(candidate_recommended)，背景(candidate_background)和其它(candidate_other)等颜色。

**layout****目录**

保存布局配置文件，SoftKeyboard只有一个配置文件:input.xml，它定义的是输入视图的信息。

**xml****目录**

method.xml，为搜索管理提供配置信息。

qwerty.xml，英文字符的全键盘布局文件。定义很直观，很容易就可以看懂。

symbols_shift.xml和symbols.xml，是标点字符的全键盘布局文件。

键盘布局以Keyboard为根目录，每一行以Row开始，每个键是一个Key

 

[参考1](http://blog.csdn.net/johnwcheung/article/details/50615584) Android TV定制输入法



SoftKeyboard源代码解析

从sample中可以看出一个输入法至少需要4个文件：

**CandidateView**：显示候选区域

**LatinKeyboard**：继承于Keyboard，负责解析并保存键盘布局，并提供选词算法，供程序运行当中使用。其中键盘布局文件以XML文件存放在资源当中。重写了createKeyFromXml方法，该方法在键盘描绘键时调用，从一个xml资源文件中载入一个键，并且放置在(x,y)坐标处。setImeOptions方法根据当前框的当前信息为回车键设置合适的label和icon。

**LatinKeyboardView**：负责显示，与CandidateView合起来，组成了InputView

**SoftKeyboard**：继承于InputMethodService，启动一个输入法就相当于启动一个InputMethodService

 

自定义键盘

[参考1](http://www.fampennings.nl/maarten/android/09keyboard/index.htm)



问题

20161107：点击隐藏键盘值时，键盘隐藏后又自动弹出

将KEYCODE_DPAD_CENTER和KEYCODE_ENTER键的处理从onKeyDown中移到onKeyUp，因为当onKeyUp返回false时，点击键盘上的隐藏键盘，键盘隐藏后会立即重新显示，可能原因是返回false的话，onKeyUp将被其他控件（如EditView）消耗重新获取了输入焦点



 