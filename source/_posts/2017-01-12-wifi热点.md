---
title: 原生设置里的热点设置
tags:
  - android
date: 2017-01-12 15:37:22
categories: 笔记
---

源码基于Android5.1.1

## Settings网络共享源码解析

原生设置的网络共享部分主要在TetherSettings类中，这是一个PreferenceFragment，其布局是tether_prefs.xml。从布局中可以看到，网络共享主要有以下几种类型：usb网络共享、wlan热点、蓝牙网络共享。





对热点的主要操作在WifiApSwitch类中

热点开关 

```java
public void setSoftapEnabled(boolean enable) {
        if (enable) {
            if (mWifiManager.getWifiState() == WifiManager.WIFI_STATE_ENABLING ||
                    mWifiManager.getWifiState() == WifiManager.WIFI_STATE_ENABLED) {
                /**
                 * Disable Wifi if enabling tethering
                 */
                mWifiManager.setWifiEnabled(false);
                setWifiSavedState(mContext, WIFI_STATE_ENABLE_ENABLING);
            }
            if (mWifiManager.setWifiApEnabled(null, enable)) {
                /* Disable here, enabled on receiving success broadcast */
                mSwitch.setEnabled(false);
            }
        } else {
            /**
             * Check if we have to wait for the WIFI_STATE_CHANGED intent before
             * we re-enable the Checkbox.
             */
            mWaitForWifiStateChange = false;

            if (mWifiManager.setWifiApEnabled(null, enable)) {
                /* Disable here, enabled on receiving success broadcast */
                mSwitch.setEnabled(false);
            }

            /**
             * If needed, restore Wifi on tether disable
             */
            if (getWifiSavedState(mContext) == WIFI_STATE_ENABLE_ENABLING) {
                mWaitForWifiStateChange = true;
                mWifiManager.setWifiEnabled(true);
                setWifiSavedState(mContext, WIFI_STATE_DISABLE_DISABLING);
            }
        }
    }
```

保存/恢复wifi状态

```java
    private static final int WIFI_STATE_ENABLE_ENABLING = 1;
    private static final int WIFI_STATE_DISABLE_DISABLING = 0;
    ...
    public static int getWifiSavedState(Context context) {
        return Settings.Global.getInt(context.getContentResolver(),
                Settings.Global.WIFI_SAVED_STATE, WIFI_STATE_DISABLE_DISABLING);
    }

    public static void setWifiSavedState(Context context, int state) {
        Settings.Global.putInt(context.getContentResolver(),
                Settings.Global.WIFI_SAVED_STATE, state);
    }
```





















