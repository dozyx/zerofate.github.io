---
title: 原生设置里的 GPS 设置
tags:
  - android
date: 2017-03-01 15:37:22
categories: 笔记
---

Android N以前，位置信息每次关闭后打开都会恢复为“精确度高”。位置信息模式定义在`/frameworks/base/core/java/android/provider/Settings.java`文件中

```java
public static final String LOCATION_MODE = "location_mode";
public static final int LOCATION_MODE_OFF = 0;
public static final int LOCATION_MODE_SENSORS_ONLY = 1;
public static final int LOCATION_MODE_BATTERY_SAVING = 2;
public static final int LOCATION_MODE_HIGH_ACCURACY = 3;
```

N版本增加了`public static final int LOCATION_MODE_PREVIOUS = -1`用于恢复上次的设置，不过目前此变量标记为`@hide`。



### 设置位置信息模式

需要系统权限

`android:name="android.permission.WRITE_SECURE_SETTINGS"`

```java
private void setLocationMode(int mode) {
		Settings.Secure.putInt(getActivity().getContentResolver(), Settings.Secure.LOCATION_MODE, mode);
	}
```



### putInt源码分析

> Android版本不一样可能有差异

源码位置platform_frameworks_base/core/java/android/provider/Settings.java

设置位置信息模式调用的是Settings.Secure.putInt(...)方法，`Location_Mode`的处理在`setLocationModeForUser`方法中

```java
private static final boolean setLocationModeForUser(ContentResolver cr, int mode,
                int userId) {
            synchronized (mLocationSettingsLock) {
                boolean gps = false;
                boolean network = false;
                switch (mode) {
                    case LOCATION_MODE_PREVIOUS:
                        // Retrieve the actual mode and set to that mode.
                        return restoreLocationModeForUser(cr, userId);
                    case LOCATION_MODE_OFF:
                        saveLocationModeForUser(cr, userId);
                        break;
                    case LOCATION_MODE_SENSORS_ONLY:
                        gps = true;
                        break;
                    case LOCATION_MODE_BATTERY_SAVING:
                        network = true;
                        break;
                    case LOCATION_MODE_HIGH_ACCURACY:
                        gps = true;
                        network = true;
                        break;
                    default:
                        throw new IllegalArgumentException("Invalid location mode: " + mode);
                }
                // Note it's important that we set the NLP mode first. The Google implementation
                // of NLP clears its NLP consent setting any time it receives a
                // LocationManager.PROVIDERS_CHANGED_ACTION broadcast and NLP is disabled. Also,
                // it shows an NLP consent dialog any time it receives the broadcast, NLP is
                // enabled, and the NLP consent is not set. If 1) we were to enable GPS first,
                // 2) a setup wizard has its own NLP consent UI that sets the NLP consent setting,
                // and 3) the receiver happened to complete before we enabled NLP, then the Google
                // NLP would detect the attempt to enable NLP and show a redundant NLP consent
                // dialog. Then the people who wrote the setup wizard would be sad.
                boolean nlpSuccess = Settings.Secure.setLocationProviderEnabledForUser(
                        cr, LocationManager.NETWORK_PROVIDER, network, userId);
                boolean gpsSuccess = Settings.Secure.setLocationProviderEnabledForUser(
                        cr, LocationManager.GPS_PROVIDER, gps, userId);
                return gpsSuccess && nlpSuccess;
            }
        }
```

保存和读取上一次的模式同样是通过provider实现，Android增加了

`public static final String LOCATION_PREVIOUS_MODE = "location_previous_mode";`

来作为存储的键。

