---
title: MVP - 学习 todo-mvp
tags:
  - mvp
date: 2017-03-15 15:37:22
categories: 笔记
---

### data

#### Task类

提供了4个字段：

+ id：String，默认`UUID.randomUUID().toString()`
+ title：String
+ description：String
+ completed：boolean，标识该task是否已完成，默认false

Task类还提供了一系列的get和is方法，但没有set方法，字段的初始化通过构造函数实现



#### TaskDataSource接口

​	TaskDataSource接口定义了访问数据源的方法以及加载task和获取task的回调接口。

```java
//加载task
interface LoadTasksCallback {
    void onTasksLoaded(List<Task> tasks);
    void onDataNotAvailable();
}
```

```java
//请求某个task
interface GetTaskCallback {
    void onTaskLoaded(Task task);
	void onDataNotAvailable();
}
```

```java
//提供数据访问的接口
void getTasks(@NonNull LoadTasksCallback callback);//获取所有的task
void getTask(@NonNull String taskId, @NonNull GetTaskCallback callback);//根据id获取某个task
void saveTask(@NonNull Task task);//保存一个task
void completeTask(@NonNull Task task);//指定task已完成(结束task)
void completeTask(@NonNull String taskId);//指定task已完成(结束task)
void activateTask(@NonNull Task task);//激活某个task
void activateTask(@NonNull String taskId);//激活某个task
void clearCompletedTasks();//清理已完成的task
void refreshTasks();//刷新所有task
void deleteAllTasks();//删除所有task
void deleteTask(@NonNull String taskId);//删除某个task
```

​	TasksLocalDataSource类和TasksRemoteDataSource类均是TaskDataSource接口的实现。

+ TasksLocalDataSource以数据库作为数据源

+ TasksRemoteDataSource模拟网络数据源(其实跟本地没区别。。。)

  ​

  除了上面两个实现，TasksRepository同样是TaskLocalDataSource接口的实现，**这三个实现都是单例形式**，并且TasksRepository会协调控制从哪个数据源获取数据，对数据源的访问主要是通过TasksRepository对象进行。


### tasks界面


#### TasksContract接口

​	该接口规定了view和presenter间的合约，里面定义了另外两个接口View和Presenter。

```java
    //此接口由含有view的界面实现，如todo中的实现在TasksFragment中
	//View向Presenter提供了操控视图的方法
	//BaseView中只有一个方法setPresenter，通过此方法向view提供presenter
	interface View extends BaseView<Presenter> {
        void setLoadingIndicator(boolean active);
        void showTasks(List<Task> tasks);
        void showAddTask();
        void showTaskDetailsUi(String taskId);
        void showTaskMarkedComplete();
        void showTaskMarkedActive();
        void showCompletedTasksCleared();
        void showLoadingTasksError();
        void showNoTasks();
        void showActiveFilterLabel();
        void showCompletedFilterLabel();
        void showAllFilterLabel();
        void showNoActiveTasks();
        void showNoCompletedTasks();
        void showSuccessfullySavedMessage();
        boolean isActive();
        void showFilteringPopUpMenu();
    }
```

```java
	//
	//BasePresenter中只有一个方法start(),view通过此方法通知presenter开始通讯
	interface Presenter extends BasePresenter {
        void result(int requestCode, int resultCode);//成功添加新task后返回
        void loadTasks(boolean forceUpdate);
        void addNewTask();
        void openTaskDetails(@NonNull Task requestedTask);
        void completeTask(@NonNull Task completedTask);
        void activateTask(@NonNull Task activeTask);
        void clearCompletedTasks();
        void setFiltering(TasksFilterType requestType);
        TasksFilterType getFiltering();
    }
```

​	TasksPresenter是TasksContract.Presenter的实现，其构造函数为：

```java
public TasksPresenter(@NonNull TasksRepository tasksRepository, @NonNull TasksContract.View tasksView) {
    //mTasksRepository向Presenter提供了访问数据源即model的方法
    mTasksRepository = checkNotNull(tasksRepository, "tasksRepository cannot be null");
  	//mTasksView为Presenter提供了访问View的方法
    mTasksView = checkNotNull(tasksView, "tasksView cannot be null!");
  	//通过setPresenter，将presenter对象的引用传给view，这样view就可以访问到presenter，从而间接与model通讯
    mTasksView.setPresenter(this);
}
```

​	

### statistics界面

​	todo中还有一个统计界面，其代码主要在StatisticsActivity、StatisticsFragment、StatisticContract、StatisticPresenter几个类中。



**StatisticContract接口**

​	与TasksContract相似，StatisticContract接口中也只定义了View和Presenter两个接口

```java
 	
	interface View extends BaseView<Presenter> {

        void setProgressIndicator(boolean active);

        void showStatistics(int numberOfIncompleteTasks, int numberOfCompletedTasks);

        void showLoadingStatisticsError();

        boolean isActive();
    }
	//view只是做了简单显示
    interface Presenter extends BasePresenter {

    }
```



### addedittask界面

​	用于添加或编辑task，该界面代码在AddEditTaskActivity、AddEditTaskFragment、AddEditTaskContract、AddEditTaskPresenter

```java
public interface AddEditTaskContract {
    interface View extends BaseView<Presenter> {
        void showEmptyTaskError();
        void showTasksList();
        void setTitle(String title);
        void setDescription(String description);
        boolean isActive();
    }
    interface Presenter extends BasePresenter {
        void saveTask(String title, String description);
        void populateTask();
        boolean isDataMissing();
    }
}
```



### taskdetail界面

​	相关代码：TaskDetailActivity、TaskDetailFragment、TaskDetailContract、TaskDetailPresenter

```java
public interface TaskDetailContract {

    interface View extends BaseView<Presenter> {
        void setLoadingIndicator(boolean active);
        void showMissingTask();
        void hideTitle();
        void showTitle(String title);
        void hideDescription();
        void showDescription(String description);
        void showCompletionStatus(boolean complete);
        void showEditTask(String taskId);
        void showTaskDeleted();
        void showTaskMarkedComplete();
        void showTaskMarkedActive();
        boolean isActive();
    }

    interface Presenter extends BasePresenter {

        void editTask();
        void deleteTask();
        void completeTask();
        void activateTask();
    }
}
```



### 总结分析

- mvp的重点是将view与model解耦，这样在view或model发生变化时，都不会对另一方造成影响
- view和model是真正的实体，而Presenter是逻辑处理
- 每个界面都对应一个Presenter，界面通过Presenter处理逻辑，而Presenter又通过View接口通知界面，这样就实现了view-presenter间的双向。
- model提供了一系列访问方法，并通过设置回调的方式回传数据。



​	todo中所有界面都遵循了同样的规范使用mvp来实现，基本思想：

+ 定义Contract合约接口，其中又包含了两类接口，一类是View类接口，由界面(todo中为fragment)来实现，其中有一个base方法setPresenter()，将Presenter对象传入view中；另一类是Presenter类接口，在构造时将View类接口的实现传入Presenter中。这样，view通过Presenter对象进行逻辑处理，而Presenter对象又通过View类接口通知View变化。
+ todo中model封装为了单例形式，在Presenter的构造函数中传入model的对象引用。