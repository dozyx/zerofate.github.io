---
title: 超时功能实现
tags:
  - android
date: 2017-02-17 15:37:22
categories: 笔记
---

[Explore by touch in TalkBack]()

​	超时是一个很见的功能，如经过一定时间隐藏对话框。对于实现延时执行的功能，作为一名新手，看到的比较多的有handler和View.post，但总感觉过于麻烦和不雅，所以希望找到一种更好的方式。

## VideoView + MediaController

​	在ApiDemon的例子可以看到这两个类是已经实现超时隐藏功能的，所以先去研究了其实现。

​	点击VideoView后触发MediaController的隐藏/显示，其源码实现如下

```java
//VideoView.java
@Override
    public boolean onTouchEvent(MotionEvent ev) {
        if (isInPlaybackState() && mMediaController != null) {
            toggleMediaControlsVisiblity();
        }
        return false;
    }
```

​	试验过程中发现一个奇怪的现象：一直按着VideoView也会有控制栏的超时隐藏。ACTION_MOVE呢？于是继承VideoView重写了onTouchEvent，结果看到只触发了ACTION_DOWN事件。原来，由于onTouchEvent返回了false导致了ACTION_DOWN后面的事件均没有处理。（之前对touch事件返回false的情形都不太了解，看到可以这样的用法，感到惊讶的同时，也感叹自己好菜）

​	结果，控制栏显示后，设置超时隐藏

```java
//MediaController.java
if (timeout != 0 && !mAccessibilityManager.isTouchExplorationEnabled()) {
            removeCallbacks(mFadeOut);
            postDelayed(mFadeOut, timeout);
        }
```

`mFadeOut`是实现隐藏的Runnable

```java
//MediaController.java
private final Runnable mFadeOut = new Runnable() {
        @Override
        public void run() {
            hide();
        }
    };
```

默认的timeout事件为3000毫秒，MediaController继承自FrameLayout，所以最后隐藏调用的也是View.postDelayed方法实现了隐藏。touch exploration是一项无障碍功能，手指在屏幕上探索，TalkBack会进行相应的播报。

> 事实上，postDelayed的最后实现还是放到了Handler的消息队列中，只是是放在了UI线程上了而已。



















