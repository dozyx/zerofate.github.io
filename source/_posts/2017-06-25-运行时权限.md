---
title: 运行时权限
tags:
  - android
  - 权限
date: 2017-06-25 15:37:22
categories: 笔记
---

[在运行时请求权限](https://developer.android.com/training/permissions/requesting.html)

​	Android 6.0 开始，用户需要在运行时授予权限，而不是安装时授予。

​	权限分为两种：

+ 正常权限，系统将自动授予该权限
+ 危险权限，需要用户授予



### 检查权限

```java
// Assume thisActivity is the current activity
int permissionCheck = ContextCompat.checkSelfPermission(thisActivity,
        Manifest.permission.WRITE_CALENDAR);
```

如果应用已具有该权限将返回 PackageManager.PERMISSION_GRANTED；不具有，则返回 PERMISSION_DENIED。



### 请求权限

​	使用 requestPermission() 进行请求，在 onRequestPermissionsResult() 中处理结果，shouldShowRequestPermissionRationale() 判断是否需要向用户做出权限解释。

> 如果用户之前请求过此权限但用户拒绝了请求，则 shouldShowRequestPermissionRationale() 方法会返回 true，如果用户在过去拒绝了权限请求，并选择了 **Don't ask again**，则该方法会返回 false，如果设备规范禁止应用具有该权限，此方法也会返回 false。

```java
// Here, thisActivity is the current activity
if (ContextCompat.checkSelfPermission(thisActivity,
                Manifest.permission.READ_CONTACTS)
        != PackageManager.PERMISSION_GRANTED) {

    // Should we show an explanation?
    if (ActivityCompat.shouldShowRequestPermissionRationale(thisActivity,
            Manifest.permission.READ_CONTACTS)) {

        // Show an expanation to the user *asynchronously* -- don't block
        // this thread waiting for the user's response! After the user
        // sees the explanation, try again to request the permission.

    } else {

        // No explanation needed, we can request the permission.

        ActivityCompat.requestPermissions(thisActivity,
                new String[]{Manifest.permission.READ_CONTACTS},
                MY_PERMISSIONS_REQUEST_READ_CONTACTS);

        // MY_PERMISSIONS_REQUEST_READ_CONTACTS is an
        // app-defined int constant. The callback method gets the
        // result of the request.
    }
}
```

```java
@Override
public void onRequestPermissionsResult(int requestCode,
        String permissions[], int[] grantResults) {
    switch (requestCode) {
        case MY_PERMISSIONS_REQUEST_READ_CONTACTS: {
            // If request is cancelled, the result arrays are empty.
            if (grantResults.length > 0
                && grantResults[0] == PackageManager.PERMISSION_GRANTED) {

                // permission was granted, yay! Do the
                // contacts-related task you need to do.

            } else {

                // permission denied, boo! Disable the
                // functionality that depends on this permission.
            }
            return;
        }

        // other 'case' lines to check for other
        // permissions this app might request
    }
}
```