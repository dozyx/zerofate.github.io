---
title: 语言设置
tags:
  - android
date: 2017-05-31 15:37:22
categories: 笔记
---

### 显示当前语言

```java
Configuration conf = getResources().getConfiguration();
String language = conf.locale.getLanguage();//如：zh
String localeString;//最终显示的文本
if (language.equals("zz")) {
	String country = conf.locale.getCountry();
	if (country.equals("ZZ")) {
		localeString = "[Developer] Accented English (zz_ZZ)";
	} else if (country.equals("ZY")) {
		localeString = "[Developer] Fake Bi-Directional (zz_ZY)";
	} else {
		localeString = "";
	}
} else if (hasOnlyOneLanguageInstance(language,
	Resources.getSystem().getAssets().getLocales())) {//如果该语言对应的种类只有一种则直接显示语言
	localeString = conf.locale.getDisplayLanguage(conf.locale);//如：中文
} else {
	localeString = conf.locale.getDisplayName(conf.locale);//显示语言+国家区域名，如：中文（中国）
}
if (localeString.length() > 1) {//将第一个字母大写
	localeString = Character.toUpperCase(localeString.charAt(0))
		+ localeString.substring(1);
	}
}
```

```java
private boolean hasOnlyOneLanguageInstance(String languageCode, String[] locales) {
	int count = 0;
	for (String localeCode : locales) {
		if (localeCode.length() > 2
			&& localeCode.startsWith(languageCode)) {
			count++;
			if (count > 1) {
				return false;
			}
		}
	}
	return count == 1;
}
```

"zz" 表示的是开发者语言（具体不是很了解）。Locale 的 getDisplayName 会更根据传入的 locale 而显示不同信息，包括：语言，国家名称，variant，locale 对应的 localized。如：

- `new Locale("en").getDisplayName(Locale.US)` -> `English`
- `new Locale("en", "US").getDisplayName(Locale.US)` -> `English (United States)`
- `new Locale("en", "US", "POSIX").getDisplayName(Locale.US)` -> `English (United States,Computer)`
- `Locale.fromLanguageTag("zh-Hant-CN").getDisplayName(Locale.US)` -> `Chinese (Traditional Han,China)`
- `new Locale("en").getDisplayName(Locale.FRANCE)` -> `anglais`
- `new Locale("en", "US").getDisplayName(Locale.FRANCE)` -> `anglais (États-Unis)`
- `new Locale("en", "US", "POSIX").getDisplayName(Locale.FRANCE)` -> `anglais (États-Unis,informatique)`.



### 设置语言

​	在原生设置中，语言设置部分在 LocalePicker 中，它是直接继承的 framework 中的 LocalePicker，最后设置语言时，调用的仍然是 framework 的 LocalePicker 的静态方法 updateLocale(Locale)，系统在更改 locale 过程中会有稍微的停顿。

```java
    /**
     * Requests the system to update the system locale. Note that the system looks halted
     * for a while during the Locale migration, so the caller need to take care of it.
     */
    public static void updateLocale(Locale locale) {
        try {
            IActivityManager am = ActivityManagerNative.getDefault();
            Configuration config = am.getConfiguration();

            // Will set userSetLocale to indicate this isn't some passing default - the user
            // wants this remembered
            config.setLocale(locale);

            am.updateConfiguration(config);
            // Trigger the dirty bit for the Settings Provider.
            BackupManager.dataChanged("com.android.providers.settings");
        } catch (RemoteException e) {
            // Intentionally left blank
        }
    }
```

​	在 Locale 类中预设了几种常用的 Locale，如

```java
public static final Locale CHINA = new Locale(true, "zh", "CN");
public static final Locale ENGLISH = new Locale(true, "en", "");
public static final Locale SIMPLIFIED_CHINESE = new Locale(true, "zh", "CN");//这里的true好像没意义。。。
...
```

​	所以，在使用 updateLocale 进行设置时可以直接配合这些变量使用。



### Locale 改变后 Activity 重建

在 locale 更换后，Activity 需要重建才能更改 Activity 的语言。如果在AndroidMainfest.xml 的 \<Activity\> 中添加 `android:configChanges="locale|layoutDirection"` 可以防止 Activity重建，但这样，Activity 的语言将不会马上替换。

在编码过程中，程序出现了fragment重复添加的问题：因为一开始在Activity的onCreate中添加了一个Fragment，然后重建后又重新添加。解决方式是在onCreate中判断 saveInstanceState 是否为 null，如果是，才添加fragment。