---
title: 修改热点配置
tags:
  - android
date: 2017-04-16 15:37:22
categories: 笔记
---

> 源码位置：com.android.settings.wifi.WifiApDialog

热点配置通过 WifiConfiguration 类表示，主要配置的是以下几部分

+ SSID，即名称

+ preSharedKey，即密码

+ 安全性，分为两种

  + 无加密

    ```java
    config.allowedKeyManagement.set(KeyMgmt.NONE);
    ```

  + WPA2 PSK

    ```java
    config.allowedKeyManagement.set(KeyMgmt.WPA2_PSK); config.allowedAuthAlgorithms.set(AuthAlgorithm.OPEN);
    ```

+ 在新的Android版本中，还有一个 AP 频段

  + 2.4 GHz 频段

  + 5 GHz 频段

    ```java
    config.apBand = mBandIndex;
    ```

#### 使配置生效

如果目前热点处于打开状态，需要重新启动

```java
			mWifiConfig = mDialog.getConfig();
			//getConfig()里的WifiConfiguration 是通过 new 得到的，所以这里有个疑问：为什么不通过
			//mWifiManager 的 getWifiApConfiguration()来设置，两者是否有区别？
            if (mWifiConfig != null) {
                if (mWifiManager.getWifiApState() == WifiManager.WIFI_AP_STATE_ENABLED) {
                    Log.d("TetheringSettings",
                            "Wifi AP config changed while enabled, stop and restart");
                    mRestartWifiApAfterConfigChange = true;//
                    mCm.stopTethering(TETHERING_WIFI);
                }
                mWifiManager.setWifiApConfiguration(mWifiConfig);
              ...
            }
```

在监听到热点已关闭广播后重新启动

```java
			if (action.equals(ConnectivityManager.ACTION_TETHER_STATE_CHANGED)) {
                // TODO - this should understand the interface types
                ArrayList<String> available = intent.getStringArrayListExtra(
                        ConnectivityManager.EXTRA_AVAILABLE_TETHER);
                ArrayList<String> active = intent.getStringArrayListExtra(
                        ConnectivityManager.EXTRA_ACTIVE_TETHER);
                ArrayList<String> errored = intent.getStringArrayListExtra(
                        ConnectivityManager.EXTRA_ERRORED_TETHER);
                updateState(available.toArray(new String[available.size()]),
                        active.toArray(new String[active.size()]),
                        errored.toArray(new String[errored.size()]));
                if (mWifiManager.getWifiApState() == WifiManager.WIFI_AP_STATE_DISABLED
                        && mRestartWifiApAfterConfigChange) {
                    mRestartWifiApAfterConfigChange = false;
                    Log.d(TAG, "Restarting WifiAp due to prior config change.");
                    startTethering(TETHERING_WIFI);
                }
            } else if (action.equals(WifiManager.WIFI_AP_STATE_CHANGED_ACTION)) {
                int state = intent.getIntExtra(WifiManager.EXTRA_WIFI_AP_STATE, 0);
                if (state == WifiManager.WIFI_AP_STATE_DISABLED
                        && mRestartWifiApAfterConfigChange) {
                    mRestartWifiApAfterConfigChange = false;
                    Log.d(TAG, "Restarting WifiAp due to prior config change.");
                    startTethering(TETHERING_WIFI);
                }
            }
			...
```

#### SSID 和 preSharedKey 限制

SSID 不能为空，且其长度不能大于 32，preSharedKey 长度不能小于8

```java
    private void validate() {
        String mSsidString = mSsid.getText().toString();
        if ((mSsid != null && mSsid.length() == 0)
                || ((mSecurityTypeIndex == WPA2_INDEX) && mPassword.length() < 8)
                || (mSsid != null &&
                Charset.forName("UTF-8").encode(mSsidString).limit() > 32)) {
            getButton(BUTTON_SUBMIT).setEnabled(false);
        } else {
            getButton(BUTTON_SUBMIT).setEnabled(true);
        }
    }
```



#### 判断芯片是否支持双频段（2.4 G 和 5 G）

```java
		String countryCode = mWifiManager.getCountryCode();
        if (!mWifiManager.isDualBandSupported() || countryCode == null) {
            //If no country code, 5GHz AP is forbidden
            // 不支持
          	...
        } else {
            ...
        }
```