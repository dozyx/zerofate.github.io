---
title: Training - 优化网络数据使用
tags:
  - android
  - 网络
date: 2017-08-02 15:37:22
categories: 笔记
---

​	从 Android 7.0 （API 24）开始，用户可以在设备范围内启用 Data Saver。当用户启用 Data Saver 并且设备处于一个计量网络时，系统将阻止后台数据使用并示意 app 在前台时尽可能减少数据的使用。用户也可以将指定 app 加入到白名单。



## 检查 Data Saver 偏好

​	在 Android 7.0 中，app 可以使用 ConnectivityManager 来确定应用了哪些数据使用限制。getRestrictBackgroundStatus() 返回以下值：

+ RESTRICT_BACKGROUND_STATUS_DISABLED：Data Saver 不可用
+ RESTRICT_BACKGROUND_STATUS_ENABLED：用户为该 app 启用了 Data Saver。
+ RESTRICT_BACKGROUND_STATUS_WHITELISTED：用户启用了 DataSaver，但将该 app 白名单化。app 仍应尽力限制前台和后台数据的使用。



​	只要设备连接到计量网络，即使用户禁用了 Data Saver 或者 app 是白名单，限制数据使用都是一种好习惯。

```java
ConnectivityManager connMgr = (ConnectivityManager)
        getSystemService(Context.CONNECTIVITY_SERVICE);
// Checks if the device is on a metered network
if (connMgr.isActiveNetworkMetered()) {
  // Checks user’s Data Saver settings.
  switch (connMgr.getRestrictBackgroundStatus()) {
    case RESTRICT_BACKGROUND_STATUS_ENABLED:
    // Background data usage is blocked for this app. Wherever possible,
    // the app should also use less data in the foreground.

    case RESTRICT_BACKGROUND_STATUS_WHITELISTED:
    // The app is whitelisted. Wherever possible,
    // the app should use less data in the foreground and background.

    case RESTRICT_BACKGROUND_STATUS_DISABLED:
    // Data Saver is disabled. Since the device is connected to a
    // metered network, the app should use less data wherever possible.
  }
} else {
  // The device is not on a metered network.
  // Use data as required to perform syncs, downloads, and updates.
}
```



### 请求白名单权限

​	如果 app 需要在后台使用数据，可以通过发送 Settings.ACTION_IGNORE_BACKGROUND_DATA_RESTRICTIONS_SETTINGS 来请求白名单权限。发送的 Intent 需要包含该 app 包名的 URI，如 `package:MY_APP_ID`。

​	发送该 Intent 和 URI 将启动 Settings 应用并显示 app 的数据使用设置。在发送 intent 之前，先询问用户是否希望启动 Settings 来启用后台数据使用是一个好的习惯。



## 监听 Data Saver 偏好更改

​	对 ConnectivityManager.ACTION_RESTRICT_BACKGROUND_CHANGED 广播进行监听，该广播只发送该广播给动态注册的receiver。在接收到该广播时，应使用 ConnectivityManager.getRestrictBackgroundStatus() 来检查新的 Data Saver 偏好设置是否影响它的权限。



## 使用 ADB 命令测试

​	ADB 提供了一些可用于在 Data Saver 条件下测试应用的命令。

+ adb shell dumpsys netpolicy

  生成一个报告，包含当前全局后台网络限制设置、当前白名单中包的 UID、其他已知包的网络权限。

+ adb shell cmd netpolicy

  显示完整的网络策略管理器列表

+ adb shell cmd netpolicy set restrict-background \<boolean>

  启用和禁用 Data Saver 模式

+ adb shell cmd netpolicy add restrict-background-whitelist \<UID>

  将指定包的 UID 添加到白名单以允许后台使用计量数据

+ adb shell cmd netpolicy remove restrict-background-whitelist \<UID>

+ adb shell cmd netpolicy list wifi-networks

  列出所有的 wifi 网络（应该是配置过的网络），并显示是否为计量网络。

+ adb shell cmd netpolicy set metered-network \<WIFI_SSID> true

  将指定 SSID 的网络视作计量网络，可以将非计量网络模拟为计量网络

  ​

  ​

  ​

  ​