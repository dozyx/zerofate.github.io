---
title: 通过 Thread 获取方法名
tags:
  - android
date: 2017-05-12 15:37:22
categories: 笔记
---

> ​	一开始，以为打印方法名利用的是stacktrack里的traceElements[3]，但实际结果在Android 模拟器上显示为traceElements[2]，3 为调用者的信息。。。世界观崩塌中，我想错了？？？网上搜索了一下，发现有人提出该数据位置不固定。。。根据实际结果，先暂时认为是下标2吧，以后知错再改。。。。

在编写打印类时，经常会使用以下方法来打印当前的方法名：

**Thread.currentThread().getStackTrace()[3].getMethodName()**

​	该方式利用了当前线程的调用栈，getStackTrace得到的是一个 StackTraceElement 数组，每条 StackTraceElement 包含了类名、文件名、方法名和行数信息。需要注意的是，getStackTrace 方法在 Android 中返回的内容结构会与纯 java 的存在出入，因为在 Android 中实际调用的是 VMStack 的 getThreadStackTrace 方法。

​	一开始还想着从源码找出为什么选择的元素下标为3，但最后跟踪到 VMStack 的getThreadStackTrace 方法时，发现此方法是一个 JNI 方法，源码位置为 `/art/runtime/native/dalvik_system_VMStack.cc`，因为水平有限，只能放弃。在这里只好通过 demo 打印来直观了解 getStackTrace 得到的 StackTraceElement[] 的样子。



Android 下打印结果：

（依次调用每个 StackTraceElement 的 toString，onClick 中执行，为使打印信息更方便查看，下面的打印内容已去掉除最后一条外的其他时间标签）

`Log.d(TAG, "[" + i + "]:" + traceElements[i].toString());`

```java
[0]:dalvik.system.VMStack.getThreadStackTrace(Native Method)
[1]:java.lang.Thread.getStackTrace(Thread.java:1566)
[2]:com.zerofate.andoroid.sample.MainActivity.onClick(MainActivity.java:20)
[3]:java.lang.reflect.Method.invoke(Native Method)
[4]:android.support.v7.app.AppCompatViewInflater$DeclaredOnClickListener.onClick(AppCompatViewInflater.java:288)
[5]:android.view.View.performClick(View.java:5637)
[6]:android.view.View$PerformClick.run(View.java:22429)
[7]:android.os.Handler.handleCallback(Handler.java:751)
[8]:android.os.Handler.dispatchMessage(Handler.java:95)
[9]:android.os.Looper.loop(Looper.java:154)
[10]:android.app.ActivityThread.main(ActivityThread.java:6119)
[11]:java.lang.reflect.Method.invoke(Native Method)
[12]:com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:886)
05-08 13:44:22.927 24577-24577/com.zerofate.andoroid.sample D/MainActivity: [13]:com.android.internal.os.ZygoteInit.main(ZygoteInit.java:776)

```



纯 Java 打印结果：

（在 main 中执行）

`System.out.println("[" + i + "]:" + traceElements[i].toString());`

```shell
[0]:java.lang.Thread.getStackTrace(Thread.java:1556)
[1]:com.zerofate.andoroid.sample.JavaTest.main(JavaTest.java:10)
[2]:sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
[3]:sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
[4]:sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
[5]:java.lang.reflect.Method.invoke(Method.java:498)
[6]:com.intellij.rt.execution.application.AppMain.main(AppMain.java:147)
```