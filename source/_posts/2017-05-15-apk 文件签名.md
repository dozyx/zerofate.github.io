---
title: apk 签名
tags:
  - android
date: 2017-05-15 15:37:22
categories: 笔记
---

参考：

《第一行代码》

[app-signing](https://developer.android.com/studio/publish/app-signing.html#release-mode)



​	Android 系统要求只有签名后的 APK 文件才可以安装，在使用 Android Studio 运行程序时，默认会自动使用默认的keystore 文件进行签名。

​	在 Android Studio Studio 右侧工具栏，Gradle -> 项目名 -> :app -> Tasks -> android，双击 signingReport，在Gradle Console窗口可以看到类似以下内容：

```
Variant: prodDebug
Config: debug
Store: /Users/zero/.android/debug.keystore
```



### 使用 Android Studio 生成 签名 APK

Build -> Generate Signed APK，根据提示填入相关信息则可以生成签名 APK。如果没有签名文件（.keystore 或 .jks），则需要新建一个。



### 使用 Gradle 生成签名 APK

如果需要在正式版中使用签名的 APK，可以在 app/build.gradle 的 android 闭包中按如下方式添加签名信息

```groovy
android{
  ...
  signingConfigs {
        config {
            storeFile file('/Users/zero/zero.jks')
            storePassword 'android'
            keyAlias 'zerokey'
            keyPassword
      }
  }
  buildTypes {
    ...
    release {
      ...
      signingConfig signingConfigs.config
    }
  }
}
```

这时候，再运行 signingReport ，可以看到以下内容

```
Variant: prodRelease
Config: config
Store: /Users/zero/zero.jks
Alias: zerokey
```

一些 release 版本的签名信息已经改变



#### 生成 APK 文件

Android Studio 中内置了很多的 GradleTasks，其中就包括了生成 APK 文件的 Task。

右侧工具栏 Gradle-> 项目名 -> :app -> Tasks -> build，

<img src="https://ws4.sinaimg.cn/large/006tKfTcgy1fin883jou1j30ge0kqabl.jpg" style="zoom:50%" />

其中 assembleDebug 用于生成测试版的 APK 文件，assembleRelease 用于生成正式版的 APK 文件，assemble 用于同时生成测试版和正式版的 APK 文件。在生成 APK 文件之前，先要双击 clean 来清理一下当前项目。

#### 提高安全性

​	前面 keystore 文件的所有信息都是以明文的形式直接配置在 build.gradle，这样安全性较差，Android 推荐的做法是将这类敏感数据配置在一个独立的文件里面，然后再在 build.gradle 中去读取这些数据。

​	Android Studio 项目的根目录下有一个 gradle.properties 文件，它是专门用来配置全局键值对数据的，在该文件中添加以下内容：

```
KEY_PATH=/Users/zero/zero.jks
KEY_PASS=android
ALIAS_NAME=zerokey
ALIAS_PASS=android
```

​	然后在 build.gradle 中读取

```
android{
  ...
  signingConfigs {
        config {
            storeFile file(KEY_PATH)
            storePassword KEY_PASS
            keyAlias ALIAS_NAME
            keyPassword ALIAS_PASS
        }
    }
}
```

​	这样，只有查看 gradle.properties 文件才能看到 keystore 的各种信息了，只要把这个文件保护好即可，比如在上传 Git 版本控制时将该文件排除。



### 使用 jarsigner 命令进行签名

​	Android Studio 中没有提供对一个未签名的 APK 直接进行签名的功能。使用 jarsigner 命令签名需按以下格式输入命令

```
jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore [keystore 文件路径] -storepass [keystore 文件密码] [待签名 APK 路径] [keystore 文件别名]
```